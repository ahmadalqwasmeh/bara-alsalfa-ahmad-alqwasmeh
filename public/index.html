<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุจุฑุง ุงูุณุงููุฉ</title>
  <style>
    body { font-family: system-ui; margin: 20px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 560px; margin: 0 auto; }
    input, button { padding: 10px; font-size: 16px; width: 100%; margin: 6px 0; }
    ul { padding-right: 18px; }
    .ok { color: green; }
    .bad { color: crimson; }
    .hint { color: #555; }
    .row { display: flex; gap: 8px; }
    .row button { width: 50%; }
    .box { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    td, th { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
    .top-credit { max-width: 560px; margin: 0 auto 12px auto; text-align: center; font-size: 13px; color: #888; }
  </style>
</head>

<body>

  <!-- ุงุณู ุงููุทูุฑ -->
  <div class="top-credit">
    ยฉ 2025 โ Developed by <b>Ahmad Alqwasmeh</b>
  </div>

  <div class="card">
    <h2>ุจุฑุง ุงูุณุงููุฉ</h2>

    <!-- ุดุงุดุฉ ุงูุฏุฎูู -->
    <div id="join">
      <input id="name" placeholder="ุงุณูู" />
      <input id="room" placeholder="ููุฏ ุงูุบุฑูุฉ (ูุซูุงู ABCD)" />
      <button id="joinBtn" type="button">ุฏุฎูู</button>
      <p id="joinErr" class="bad"></p>
    </div>

    <!-- ุดุงุดุฉ ุงูููุจู/ุงููุนุจ -->
    <div id="lobby" style="display:none;">
      <h3>ุงูุบุฑูุฉ: <span id="roomLbl"></span></h3>
      <p id="connStatus" class="hint" style="margin-top:6px;">
  โ ูุชุตู
</p>


      <div class="box">
        <b>ุงูููุงุท ุงูุญุงููุฉ</b>
        <ul id="scores"></ul>
      </div>

      <p><b>ุงููุงุนุจูู:</b></p>
      <ul id="players"></ul>

      <div class="row">
        <!-- ูุฐุง ุฒุฑ ุฌุงูุฒูุฉ ูุจุฏุก ุงูุฌููุฉ -->
        <button id="startBtn" type="button">ุฌุงูุฒ ูุจุฏุก ุงูุฌููุฉ</button>
        <button id="voteBtn" type="button" disabled>ุชุตููุช</button>
      </div>

      <p id="startProg" class="hint"></p>

      <!-- ูููุณุคูู ููุท -->
      <div id="leaderBox" class="box" style="display:none;">
        <p class="hint">โ ุฃูุช ุงููุณุคูู! ุงูุชุจ ุงููููุฉ/ุงูููุถูุน ุซู ุงุถุบุท ุฅุฑุณุงู:</p>
        <input id="topic" placeholder="ูุซุงู: ููุงูู / ุณูุงุฑุงุช / ุฃููุงู..." />
        <button id="sendTopicBtn" type="button">ุฅุฑุณุงู ุงูููุถูุน</button>
      </div>

      <!-- ูุจุฑุง ุงูุณุงููุฉ ููุท -->
      <div id="outsiderGuessBox" class="box" style="display:none;">
        <p class="hint">๐ต๏ธโโ๏ธ ุฃูุช ุจุฑุง ุงูุณุงููุฉ! ุฎูู ุงูููุถูุน:</p>
        <input id="guess" placeholder="ุงูุชุจ ุชุฎูููู..." />
        <button id="sendGuessBtn" type="button">ุฅุฑุณุงู ุงูุชุฎููู</button>
      </div>

      <p id="msg"></p>
      <p id="role"></p>
      <p id="voteProgress" class="hint"></p>
    </div>

    <!-- ุดุงุดุฉ ุงูุชุตููุช -->
    <div id="voting" style="display:none;">
      <h3>ุชุตููุช: ููู ุจุฑุง ุงูุณุงููุฉุ</h3>
      <div id="voteList" class="box"></div>
      <button id="submitVoteBtn" type="button">ุชุฃููุฏ ุงูุชุตููุช</button>
      <button id="backBtn" type="button" style="margin-top:0;">ุฑุฌูุน</button>
      <p id="voteErr" class="bad"></p>
    </div>

    <!-- ุดุงุดุฉ ุงููุชุงุฆุฌ -->
    <div id="results" style="display:none;">
      <h3>ูุชุงุฆุฌ ุงูุฌููุฉ</h3>
      <p id="roundSummary"></p>

      <div class="box">
        <b>ููุญุฉ ุงูููุงุท</b>
        <table>
          <thead><tr><th>ุงููุงุนุจ</th><th>ุงูููุงุท</th></tr></thead>
          <tbody id="scoreTable"></tbody>
        </table>
      </div>

      <button id="newRoundBtn" type="button">ุฌุงูุฒ ูุฌููุฉ ุฌุฏูุฏุฉ</button>
      <p id="nextProg" class="hint"></p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // โ ูููุฉ ุซุงุจุชุฉ ููุงุนุจ (ุญุชู ูู ูุงู ุงูุชูููู/ุฑุงุญ ูุชุทุจูู ุซุงูู)
    let playerKey = localStorage.getItem("playerKey");
    if (!playerKey) {
      playerKey = (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random()));
      localStorage.setItem("playerKey", playerKey);
    }

    // ุนูุงุตุฑ
    const joinDiv = document.getElementById("join");
    const lobbyDiv = document.getElementById("lobby");
    const votingDiv = document.getElementById("voting");
    const resultsDiv = document.getElementById("results");

    const nameInp = document.getElementById("name");
    const roomInp = document.getElementById("room");
    const joinBtn = document.getElementById("joinBtn");
    const joinErr = document.getElementById("joinErr");

    const roomLbl = document.getElementById("roomLbl");
    const connStatus = document.getElementById("connStatus");
    let connTimer = null;

function setConn(text, cls) {
  if (!connStatus) return;
  connStatus.textContent = text;
  connStatus.className = cls || "hint";
}

// โ ุฃูู ูุง ูุชุตู
socket.on("connect", () => {
  setConn("โ ูุชุตู", "ok");

  // ุฅุฐุง ููุช ุฑุงุฌุน ูู ุงููุทุงุนุ ูุธูู ุฃู ูุคูุช
  if (connTimer) {
    clearTimeout(connTimer);
    connTimer = null;
  }
});

// ๐ก ููุง ููุตู ุงูุงุชุตุงู (ุณููู/ุชุทุจูู ุซุงูู/ูุช)
socket.on("disconnect", (reason) => {
  setConn("๐ก ุงููุทุน ุงูุงุชุตุงูโฆ ุจุญุงูู ุฃุนูุฏ ุงูุงุชุตุงู", "hint");

  // ุฅุฐุง ุทูู ุฃูุซุฑ ูู 20 ุซุงููุฉุ ูุบููุฑูุง ูุชุญุฐูุฑ ุฃูุถุญ
  if (connTimer) clearTimeout(connTimer);
  connTimer = setTimeout(() => {
    setConn("๐ด ุงูุงุชุตุงู ูุด ุซุงุจุชโฆ ุชุฃูุฏ ูู ุงููุช ุฃู ุงุฑุฌุน ุงูุชุญ ุงูุตูุญุฉ", "bad");
  }, 20000);
});

// ๐ก ุฃุซูุงุก ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู
socket.io.on("reconnect_attempt", (attempt) => {
  setConn(`๐ก ุจุญุงูู ุฃุนูุฏ ุงูุงุชุตุงูโฆ ูุญุงููุฉ ${attempt}`, "hint");
});

// โ ููุง ูุฑุฌุน ุงูุงุชุตุงู ุจุนุฏ ุงููุทุงุน
socket.io.on("reconnect", () => {
  setConn("โ ุฑุฌุน ุงูุงุชุตุงู", "ok");
  if (connTimer) {
    clearTimeout(connTimer);
    connTimer = null;
  }
});

// ๐ด ูู ูุดู ูุนูุฏ ุงูุงุชุตุงู
socket.io.on("reconnect_failed", () => {
  setConn("๐ด ูุดู ุฅุนุงุฏุฉ ุงูุงุชุตุงูโฆ ุฌุฑูุจ ุญุฏูุซ ุงูุตูุญุฉ", "bad");
});

    const playersUl = document.getElementById("players");
    const scoresUl = document.getElementById("scores");

    const startBtn = document.getElementById("startBtn");
    const startProg = document.getElementById("startProg");

    const voteBtn = document.getElementById("voteBtn");
    const voteProgress = document.getElementById("voteProgress");

    const leaderBox = document.getElementById("leaderBox");
    const topicInp = document.getElementById("topic");
    const sendTopicBtn = document.getElementById("sendTopicBtn");

    const outsiderGuessBox = document.getElementById("outsiderGuessBox");
    const guessInp = document.getElementById("guess");
    const sendGuessBtn = document.getElementById("sendGuessBtn");

    const msg = document.getElementById("msg");
    const role = document.getElementById("role");

    const voteList = document.getElementById("voteList");
    const submitVoteBtn = document.getElementById("submitVoteBtn");
    const backBtn = document.getElementById("backBtn");
    const voteErr = document.getElementById("voteErr");

    const roundSummary = document.getElementById("roundSummary");
    const scoreTable = document.getElementById("scoreTable");
    const newRoundBtn = document.getElementById("newRoundBtn");
    const nextProg = document.getElementById("nextProg");

    let currentRoom = "";
    let selectedVoteId = null;

    function must(v){ return (v || "").trim(); }

    function show(screen) {
      joinDiv.style.display = (screen === "join") ? "block" : "none";
      lobbyDiv.style.display = (screen === "lobby") ? "block" : "none";
      votingDiv.style.display = (screen === "voting") ? "block" : "none";
      resultsDiv.style.display = (screen === "results") ? "block" : "none";
    }

    function resetRoundUI() {
      msg.textContent = "";
      msg.className = "";
      role.textContent = "";
      role.className = "";

      voteProgress.textContent = "";
      voteErr.textContent = "";

      leaderBox.style.display = "none";
      outsiderGuessBox.style.display = "none";

      topicInp.value = "";
      guessInp.value = "";

      sendTopicBtn.disabled = false;
      submitVoteBtn.disabled = false;

      // ุฃุซูุงุก ุงูููุจู: ุฒุฑ ุงูุชุตููุช ูููุชุญ ูุงุญููุง ููุท ููุง ูุตูุฑ discussion_ready
      voteBtn.disabled = true;
    }

    // โ ุฒุฑ ุฑุฌูุน: ูุฑุฌุน ููููุจู ููุท (ุจุฏูู ุฃู Refresh)
    backBtn.onclick = () => {
      show("lobby");
    };

    // ุฒุฑ ุฏุฎูู
    joinBtn.onclick = () => {
      joinErr.textContent = "";
      const name = must(nameInp.value);
      const roomCode = must(roomInp.value).toUpperCase();

      if (!name || !roomCode) {
        joinErr.textContent = "ุงูุชุจ ุงูุงุณู ูููุฏ ุงูุบุฑูุฉ";
        return;
      }

      currentRoom = roomCode;
      roomLbl.textContent = roomCode;

      // ุญูุธ ููู auto-rejoin
      localStorage.setItem("roomCode", roomCode);
      localStorage.setItem("playerName", name);

      show("lobby");
      resetRoundUI();

      startBtn.disabled = false;
      startProg.textContent = "";
      nextProg.textContent = "";

      socket.emit("join_room", { roomCode, name, playerKey });
    };

    // โ auto rejoin ุนูุฏ ุฑุฌูุน ุงูุงุชุตุงู
    socket.on("connect", () => {
      const roomCode = localStorage.getItem("roomCode");
      const name = localStorage.getItem("playerName");
      if (roomCode && name) {
        currentRoom = roomCode;
        roomLbl.textContent = roomCode;
        socket.emit("join_room", { roomCode, name, playerKey });
      }
    });

    // ุฌุงูุฒ ูุจุฏุก ุงูุฌููุฉ (ูุง ุชุจุฏุฃ ุฅูุง ููุง ุงููู ูุถุบุท)
    startBtn.onclick = () => {
      if (!currentRoom) return;
      startBtn.disabled = true;
      startProg.textContent = "โ ุชู ุชุณุฌูู ุฌุงูุฒูุชูโฆ ุงุณุชูู ุงูุจุงูู.";
      resetRoundUI();
      socket.emit("ready_start_round", { roomCode: currentRoom, playerKey });
    };

    // ูุชุญ ุงูุชุตููุช (ุงูุณูุฑูุฑ ูู ุงููู ููุฑุฑ ููู ูุดูู ุดุงุดุฉ ุงูุชุตููุช)
    voteBtn.onclick = () => {
      if (!currentRoom) return;
      socket.emit("open_voting", { roomCode: currentRoom });
    };

    // ุฅุฑุณุงู ููุถูุน (ุงููุณุคูู)
    sendTopicBtn.onclick = () => {
      if (!currentRoom) return;
      socket.emit("submit_topic", { roomCode: currentRoom, topic: topicInp.value });
    };

    // ุฅุฑุณุงู ุชุฎููู (ุจุฑุง ุงูุณุงููุฉ)
    sendGuessBtn.onclick = () => {
      if (!currentRoom) return;
      socket.emit("submit_outsider_guess", { roomCode: currentRoom, guess: guessInp.value });
    };

    // ุชุฃููุฏ ุงูุชุตููุช
    submitVoteBtn.onclick = () => {
      voteErr.textContent = "";
      if (!selectedVoteId) {
        voteErr.textContent = "ุงุฎุชุงุฑ ุงุณู ูุจู ุงูุชุฃููุฏ";
        return;
      }
      submitVoteBtn.disabled = true;
      voteErr.textContent = "โ ุชู ุฅุฑุณุงู ุตูุชูุ ุงุณุชูู ุงูุจุงูู...";
      socket.emit("submit_vote", { roomCode: currentRoom, playerKey, targetId: selectedVoteId });
    };

    // ุฌุงูุฒ ูุฌููุฉ ุฌุฏูุฏุฉ (ูุง ุชุจุฏุฃ ุฅูุง ููุง ุงููู ูุถุบุท)
    newRoundBtn.onclick = () => {
      if (!currentRoom) return;
      newRoundBtn.disabled = true;
      nextProg.textContent = "โ ุชู ุชุณุฌูู ุฌุงูุฒูุชูโฆ ุงุณุชูู ุงูุจุงูู.";
      socket.emit("ready_next_round", { roomCode: currentRoom, playerKey });
    };

    // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุงุนุจูู ูุงูููุงุท
    socket.on("room_update", ({ players }) => {
      playersUl.innerHTML = players.map(p => `<li>${p.name}</li>`).join("");
      scoresUl.innerHTML = players
        .slice()
        .sort((a,b) => b.score - a.score)
        .map(p => `<li>${p.name}: <b>${p.score}</b></li>`)
        .join("");
    });

    // ุชูุฏู ุฌุงูุฒูู ูุจุฏุก ุงูุฌููุฉ
    socket.on("start_round_progress", ({ readyCount, total }) => {
      startProg.textContent = `ุงูุฌุงูุฒูู ูุจุฏุก ุงูุฌููุฉ: ${readyCount} / ${total}`;
      if (readyCount === 0) {
        startBtn.disabled = false;
      }
    });

    // ุจุฏุงูุฉ ุงูุฌููุฉ
    socket.on("round_started", ({ leaderName }) => {
      show("lobby");
      resetRoundUI();

      // ุฃุนุฏ ุชูุนูู ุฃุฒุฑุงุฑ ุงูุฌุงูุฒูุฉ ููุฌููุงุช ุงููุงุฏูุฉ
      startBtn.disabled = false;
      startProg.textContent = "";
      newRoundBtn.disabled = false;
      nextProg.textContent = "";

      msg.innerHTML = `๐ฒ ุชู ุงุฎุชูุงุฑ <b>${leaderName}</b> ูููุณุคูู ููุฐู ุงูุฌููุฉ.`;
      msg.className = "";
    });

    // ุงููุณุคูู ูุณุชูุจู ุจููุณ ุงูููุถูุน
    socket.on("leader_prompt_topic", () => {
      leaderBox.style.display = "block";
      msg.textContent = "";
    });

    socket.on("leader_topic_locked", () => {
      sendTopicBtn.disabled = true;
      leaderBox.style.display = "none";
    });

    // ุงูููุถูุน ูููุดุงุฑููู
    socket.on("topic_revealed", ({ topic }) => {
      role.textContent = `๐งฉ ุงูููุถูุน: ${topic}`;
      role.className = "ok";
    });

    // ุงูููุถูุน ูุฎูู ูุจุฑุง ุงูุณุงููุฉ
    socket.on("topic_hidden", () => {
      role.textContent = "๐ต๏ธโโ๏ธ ุงูุช ุจุฑุง ุงูุณุงููุฉโฆ ุงูููุถูุน ูุฎูู ุนูู!";
      role.className = "bad";
    });

    // ุฌุงูุฒูุฉ ููููุงุด ููุชุญ ุฒุฑ ุงูุชุตููุช
    socket.on("discussion_ready", () => {
      voteBtn.disabled = false;
      voteProgress.textContent = "ุฌุงูุฒูู ููููุงุดโฆ ูููุง ุจุฏูู ุงุถุบุทูุง (ุชุตููุช)";
    });

    // โ ูุชุญ ุดุงุดุฉ ุงูุชุตููุช (ุงูุณูุฑูุฑ ูุง ูุฑุณููุง ูููุณุคูู)
    socket.on("voting_open", ({ players }) => {
      selectedVoteId = null;
      submitVoteBtn.disabled = false;
      voteErr.textContent = "";

      // ุงูุณูุฑูุฑ ุฃุตูุงู ุจููุตู ูุงุฆูุฉ ุจุฏูู ุงููุณุคูู ูุจุฏูููุ
      // ุจุณ ูุฎูููุง ููุชุฑุฉ ุฅุถุงููุฉ ููุฃูุงู:
      const filtered = (players || []).filter(p => p.id && p.id !== socket.id);

      voteList.innerHTML = filtered.map(p => `
        <label style="display:block; padding:8px; border-bottom:1px solid #eee; cursor:pointer;">
          <input type="radio" name="vote" value="${p.id}" style="margin-left:8px;">
          ${p.name}
        </label>
      `).join("");

      voteList.querySelectorAll('input[name="vote"]').forEach(inp => {
        inp.addEventListener("change", (e) => {
          selectedVoteId = e.target.value;
        });
      });

      show("voting");
    });

    // ุชูุฏู ุงูุชุตููุช (ุนุฏุฏ ุงููุตููุชูู / ุงูุฅุฌูุงูู)
    socket.on("vote_progress", ({ votedCount, total }) => {
      voteProgress.textContent = `ุงูุชุตููุช: ${votedCount} / ${total}`;
    });

    // ูุชูุฌุฉ ุงูุชุตููุช
    socket.on("voting_result", ({ accusedName, outsiderCaught, outsiderName }) => {
      show("lobby");
      msg.innerHTML = outsiderCaught
        ? `โ ุชู ุงุชูุงู <b>${accusedName}</b>โฆ ูุทูุน ูู ูุนููุง <b>ุจุฑุง ุงูุณุงููุฉ</b>!`
        : `โ ุชู ุงุชูุงู <b>${accusedName}</b>โฆ ูููู <b>ูุด</b> ุจุฑุง ุงูุณุงููุฉ. ุจุฑุง ุงูุณุงููุฉ ุงูุญูููู ูู <b>${outsiderName}</b>.`;
      msg.className = outsiderCaught ? "ok" : "bad";

      voteBtn.disabled = true;
      voteProgress.textContent = "";
    });

    // ุจููุณ ุชุฎููู ุจุฑุง ุงูุณุงููุฉ
    socket.on("outsider_guess_prompt", () => {
      outsiderGuessBox.style.display = "block";
    });

    // ุงููุชุงุฆุฌ
    socket.on("round_results", ({ correct, topic, scoreboard }) => {
      show("results");

      newRoundBtn.disabled = false;
      nextProg.textContent = "";

      roundSummary.innerHTML = correct
        ? `๐ ุจุฑุง ุงูุณุงููุฉ ุฎูู ุตุญ! <b>ุงูููุถูุน ูุงู:</b> ${topic}`
        : `๐ ุจุฑุง ุงูุณุงููุฉ ุฎูู ุบูุท. <b>ุงูููุถูุน ูุงู:</b> ${topic}`;

      scoreTable.innerHTML = (scoreboard || [])
        .map(r => `<tr><td>${r.name}</td><td><b>${r.score}</b></td></tr>`)
        .join("");
    });

    // ุชูุฏู ุงูุฌุงูุฒูู ููุฌููุฉ ุงูุฌุฏูุฏุฉ
    socket.on("next_round_progress", ({ readyCount, total }) => {
      nextProg.textContent = `ุงูุฌุงูุฒูู ููุฌููุฉ ุงูุฌุฏูุฏุฉ: ${readyCount} / ${total}`;
    });

    // ุฑุณุงุฆู ุฎุทุฃ
    socket.on("error_msg", (t) => {
      // ูุง ูุฎุฑุจ ุงูุฌููุฉ.. ุจุณ ูุนุฑุถ ุงูุฎุทุฃ
      msg.textContent = t;
      msg.className = "bad";
      voteErr.textContent = t;
      // ุฎูู ุฒุฑ ุงูุชุตููุช ูุฑุฌุน ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุจุงูุดุงุดุฉ
      submitVoteBtn.disabled = false;
    });

    // (ุงุฎุชูุงุฑู) ุชุฃููุฏ ุฏุฎูู/ุนูุฏุฉ
    socket.on("join_ok", ({ rejoined }) => {
      if (rejoined) {
        msg.textContent = "โ ุฑุฌุนุช ููุบุฑูุฉ ุจูุฌุงุญ";
        msg.className = "ok";
      }
    });
  </script>
</body>
</html>

